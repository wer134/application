<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>Spotlight Cam - AI ê°ì²´ ì¶”ì  ë° ë°°ê²½ ì œê±°</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- 
        Spotlight Cam ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ
        ì „ì²´ UIì˜ ìµœìƒìœ„ ë˜í¼ ìš”ì†Œ
    -->
    <div class="spotlight-window">
        
        <header class="app-menubar">
            <div class="menu-item">
                <span>File</span>
                <ul class="dropdown-menu">
                    <li id="menu-show-recordings">Show Recordings</li>
                    <li id="menu-settings">Settings</li>
                    <li id="menu-exit">Exit</li>
                </ul>
            </div>
            <div class="menu-item">
                <span>Edit</span>
                <ul class="dropdown-menu">
                    <li id="menu-copy">Copy</li>
                    <li id="menu-paste">Paste</li>
                </ul>
            </div>
            <div class="menu-item">
                <span>View</span>
                <ul class="dropdown-menu">
                    <li id="menu-toggle-fullscreen">Toggle Fullscreen</li>
                    <li>Docks</li>
                    <hr> <li id="menu-reload"> Force Reload</li>
                    <li id="menu-toggle-devtool">Toggle Developer Tools</li>
                </ul>
            </div>
            <div class="menu-item">
                <span>Tools</span>
                <ul class="dropdown-menu">
                    <li>Auto-Configuration Wizard</li>
                    <li>Scripts</li>
                </ul>
            </div>
            <div class="menu-item">
                <span>Help</span>
                <ul class="dropdown-menu">
                    <li id="menu-check-updates">Check for Updates</li>
                    <li id="menu-about">About</li>
                </ul>
            </div>
        </header>

        <main class="main-content">

            <section class="preview-area" id="preview-area">
                <!-- ì²˜ë¦¬ ì „/í›„ ë¹„êµ ëª¨ë“œ -->
                <div id="comparison-container">
                    <div class="comparison-video-wrapper">
                        <div class="comparison-label original-label">ì›ë³¸</div>
                        <video id="original-video" autoplay muted playsinline></video>
                    </div>
                    <div class="comparison-video-wrapper processed">
                        <div class="comparison-label processed-label">ì²˜ë¦¬ í›„</div>
                        <video id="processed-video" autoplay muted playsinline></video>
                    </div>
                </div>
                <!-- ì¼ë°˜ ëª¨ë“œ -->
                <video id="main-video-feed" autoplay muted playsinline></video>
            </section>

            <section class="docks-container">
                
                <div class="dock-panel" id="scenes-panel">
                    <div class="dock-header"><h3>Scenes</h3></div>
                    <div class="dock-content">
                        <ul id="scenes-list">
                            <li class="scene-item active" data-scene-id="0">Scene</li>
                        </ul>
                    </div>
                    <div class="dock-toolbar">
                        <button id="add-scene-btn" title="ì¥ë©´ ì¶”ê°€">+</button>
                        <button id="remove-scene-btn" title="ì¥ë©´ ì‚­ì œ">-</button>
                        <button id="move-scene-up-btn" title="ìœ„ë¡œ ì´ë™">â®</button>
                        <button id="move-scene-down-btn" title="ì•„ë˜ë¡œ ì´ë™">â®Ÿ</button>
                    </div>
                </div>
                
                <div class="dock-panel" id="sources-panel">
                    <div class="dock-header"><h3>Sources</h3></div>
                    <div class="dock-content" id="sources-content">
                        <ul id="sources-list"></ul>
                        <div class="center-text" id="sources-empty" style="display: none;">
                            <p>You don't have any sources.<br>Click the + button below,<br>or right click here to add one.</p>
                            <div class="source-icons">
                                <span>ğŸ“</span>
                                <span>ğŸ’»</span>
                                <span>ğŸ¤</span>
                            </div>
                        </div>
                    </div>
                    <div class="dock-toolbar">
                        <button id="add-source-btn" title="ì†ŒìŠ¤ ì¶”ê°€">+</button>
                        <button id="remove-source-btn" title="ì†ŒìŠ¤ ì‚­ì œ">-</button>
                        <button id="source-settings-btn" title="ì†ŒìŠ¤ ì„¤ì •">âš™</button>
                        <button id="move-source-up-btn" title="ìœ„ë¡œ ì´ë™">â®</button>
                        <button id="move-source-down-btn" title="ì•„ë˜ë¡œ ì´ë™">â®Ÿ</button>
                    </div>
                </div>

                <div class="dock-panel" id="audio-mixer-panel">
                    <div class="dock-header"><h3>Audio Mixer</h3></div>
                    <div class="dock-content">
                        <div class="audio-track" data-track="desktop">
                            <div class="track-header">
                                <span>Desktop Audio</span>
                                <span class="db-display">0.0 dB</span>
                                <span class="icon-button">âš™</span>
                            </div>
                            <div class="volume-meter">
                                <div class="meter-fill" data-meter-name="desktop"></div>
                            </div>
                            <div class="track-controls">
                                <span class="icon-button mute-btn" data-mute="desktop">ğŸ”‡</span>
                                <input type="range" class="volume-slider" data-volume="desktop" min="-100" max="0" value="0">
                            </div>
                        </div>
                        <div class="audio-track" data-track="mic">
                            <div class="track-header">
                                <span>Mic/Aux</span>
                                <span class="db-display">0.0 dB</span>
                                <span class="icon-button">âš™</span>
                            </div>
                            <div class="volume-meter">
                                <div class="meter-fill" data-meter-name="mic"></div>
                            </div>
                            <div class="track-controls">
                                <span class="icon-button mute-btn" data-mute="mic">ğŸ”‡</span>
                                <input type="range" class="volume-slider" data-volume="mic" min="-100" max="0" value="0">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dock-panel" id="controls-panel">
                    <div class="dock-header"><h3>Controls</h3></div>
                    <div class="dock-content">
                        <button class="control-btn" id="start-recording-btn">Start Recording</button>
                        <button class="control-btn" id="toggle-background-removal">ë°°ê²½ ì œê±°: OFF</button>
                        <button class="control-btn" id="toggle-comparison">ì „/í›„ ë¹„êµ ë³´ê¸°</button>
                        <button class="control-btn" id="open-settings">Settings</button>
                        <button class="control-btn" id="exit-button">Exit</button>
                    </div>
                </div>

            </section>
        </main>

        <footer class="status-bar">
            <div class="status-left">
                <span>LIVE: 00:00:00</span>
                <span id="rec-status">REC: 00:00:00</span>
                <span id="pi-status" style="margin-left: 20px;">
                    <span id="pi-status-indicator" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: var(--color-danger); margin-right: 5px;"></span>
                    <span id="pi-status-text">ë¼ì¦ˆë² ë¦¬íŒŒì´: ì—°ê²° ì•ˆ ë¨</span>
                </span>
            </div>
            <div class="status-right">
                <span>CPU: 3.8%, 60.00 fps</span>
            </div>
        </footer>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <h2>ì„¤ì • (Settings)</h2>
            
            <fieldset>
                <legend>ë¹„ë””ì˜¤ ì„¤ì •</legend>
                <div class="setting-item">
                    <label for="video-source">ì¹´ë©”ë¼:</label>
                    <select id="video-source">
                        </select>
                </div>
                <div class="setting-item">
                    <label for="video-resolution">í•´ìƒë„:</label>
                    <select id="video-resolution">
                        <option value="auto">ìë™</option>
                        <option value="1080p">1920x1080</option>
                        <option value="720p">1280x720</option>
                    </select>
                </div>
            </fieldset>
            
            <fieldset>
                <legend>ì˜¤ë””ì˜¤ ì„¤ì •</legend>
                <div class="setting-item">
                    <label for="audio-source">ë§ˆì´í¬:</label>
                    <select id="audio-source">
                        </select>
                </div>
            </fieldset>
            
            <fieldset>
                <legend>ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²°</legend>
                <div class="setting-item">
                    <label for="raspberry-pi-ip">ë¼ì¦ˆë² ë¦¬íŒŒì´ IP ì£¼ì†Œ:</label>
                    <div style="display: flex; gap: 5px; flex-grow: 1;">
                        <input type="text" id="raspberry-pi-ip" placeholder="ì˜ˆ: 192.168.1.100" style="flex-grow: 1; background-color: var(--bg-medium); color: var(--text-primary); border: 1px solid var(--border-color); padding: 5px; border-radius: 3px; font-size: 0.9em;">
                        <input type="number" id="raspberry-pi-port" placeholder="í¬íŠ¸" value="8765" min="1" max="65535" style="width: 80px; background-color: var(--bg-medium); color: var(--text-primary); border: 1px solid var(--border-color); padding: 5px; border-radius: 3px; font-size: 0.9em;">
                    </div>
                </div>
                <div class="setting-item">
                    <label>ì—°ê²° ìƒíƒœ:</label>
                    <div style="display: flex; align-items: center; gap: 10px; flex-grow: 1;">
                        <span id="pi-connection-status" style="padding: 5px 10px; border-radius: 3px; font-size: 0.9em; background-color: var(--bg-medium);">ì—°ê²° ì•ˆ ë¨</span>
                        <button class="control-btn" id="connect-pi-btn" style="flex-shrink: 0;">ì—°ê²°</button>
                        <button class="control-btn" id="disconnect-pi-btn" style="flex-shrink: 0; display: none;">ì—°ê²° í•´ì œ</button>
                    </div>
                </div>
            </fieldset>
            
            <fieldset>
                <legend>ì¶œë ¥ (ì €ì¥)</legend>
                <div class="setting-item">
                    <label for="file-format">íŒŒì¼ í˜•ì‹:</label>
                    <select id="file-format">
                        <option value="webm">WebM (ê¶Œì¥)</option>
                        <option value="mp4">MP4 (ë³€í™˜ í•„ìš”)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>ì €ì¥ ìœ„ì¹˜:</label>
                    <div style="display: flex; gap: 5px; flex-grow: 1;">
                        <input type="text" id="save-path-display" readonly style="flex-grow: 1; background-color: var(--bg-medium); color: var(--text-primary); border: 1px solid var(--border-color); padding: 5px; border-radius: 3px; font-size: 0.9em;">
                        <button class="control-btn" id="set-save-path" style="flex-shrink: 0;">ì„ íƒ...</button>
                    </div>
                </div>
            </fieldset>

            <div class="modal-buttons">
                <button class="control-btn" id="close-settings">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="add-source-modal">
        <div class="modal-content">
            <h2>ì†ŒìŠ¤ ì¶”ê°€</h2>
            <fieldset>
                <legend>ì†ŒìŠ¤ íƒ€ì… ì„ íƒ</legend>
                <div class="setting-item">
                    <label>
                        <input type="radio" name="source-type" value="video" checked>
                        ë¹„ë””ì˜¤ ìº¡ì²˜ ì¥ì¹˜
                    </label>
                </div>
                <div class="setting-item">
                    <label>
                        <input type="radio" name="source-type" value="image">
                        ì´ë¯¸ì§€
                    </label>
                </div>
                <div class="setting-item">
                    <label>
                        <input type="radio" name="source-type" value="text">
                        í…ìŠ¤íŠ¸
                    </label>
                </div>
            </fieldset>
            <fieldset id="source-options">
                <legend>ì˜µì…˜</legend>
                <div class="setting-item" id="video-option">
                    <label for="source-video-device">ë¹„ë””ì˜¤ ì¥ì¹˜:</label>
                    <select id="source-video-device"></select>
                </div>
                <div class="setting-item" id="image-option" style="display: none;">
                    <label for="source-image-file">ì´ë¯¸ì§€ íŒŒì¼:</label>
                    <input type="file" id="source-image-file" accept="image/*">
                </div>
                <div class="setting-item" id="text-option" style="display: none;">
                    <label for="source-text-content">í…ìŠ¤íŠ¸ ë‚´ìš©:</label>
                    <input type="text" id="source-text-content" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="setting-item">
                    <label for="source-name">ì†ŒìŠ¤ ì´ë¦„:</label>
                    <input type="text" id="source-name" placeholder="ì†ŒìŠ¤ ì´ë¦„">
                </div>
            </fieldset>
            <div class="modal-buttons">
                <button class="control-btn" id="add-source-confirm">ì¶”ê°€</button>
                <button class="control-btn" id="cancel-add-source">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="add-scene-modal">
        <div class="modal-content">
            <h2>ì¥ë©´ ì¶”ê°€</h2>
            
            <fieldset>
                <legend>ì¥ë©´ ì •ë³´</legend>
                <div class="setting-item">
                    <label for="scene-name-input">ì¥ë©´ ì´ë¦„:</label>
                    <input type="text" id="scene-name-input" placeholder="ì¥ë©´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex-grow: 1; background-color: var(--bg-medium); color: var(--text-primary); border: 1px solid var(--border-color); padding: 5px; border-radius: 3px; font-size: 0.9em;">
                </div>
            </fieldset>

            <div class="modal-buttons">
                <button class="control-btn" id="add-scene-confirm">ì¶”ê°€</button>
                <button class="control-btn" id="cancel-add-scene">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>


    <script>
        /**
         * Spotlight Cam ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
         * DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
         */
        document.addEventListener("DOMContentLoaded", () => {
            // ============================================
            // DOM ìš”ì†Œ ì°¸ì¡°
            // ============================================
            const videoFeed = document.getElementById('main-video-feed');          // ë©”ì¸ ë¹„ë””ì˜¤ í‘œì‹œ ìš”ì†Œ
            const videoSelect = document.getElementById('video-source');          // ë¹„ë””ì˜¤ ì¥ì¹˜ ì„ íƒ ë“œë¡­ë‹¤ìš´
            const audioSelect = document.getElementById('audio-source');           // ì˜¤ë””ì˜¤ ì¥ì¹˜ ì„ íƒ ë“œë¡­ë‹¤ìš´
            const sourcesContent = document.getElementById('sources-content');     // ì†ŒìŠ¤ íŒ¨ë„ ì»¨í…ì¸  ì˜ì—­
            const startRecordingBtn = document.getElementById('start-recording-btn'); // ë…¹í™” ì‹œì‘/ì¤‘ì§€ ë²„íŠ¼
            const recStatus = document.getElementById('rec-status');               // ë…¹í™” ìƒíƒœ í‘œì‹œ ìš”ì†Œ

            // ============================================
            // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
            // ============================================
            let mediaStream = null;                    // í˜„ì¬ í™œì„±í™”ëœ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ (ì¹´ë©”ë¼/ë§ˆì´í¬)
            let mediaRecorder = null;                  // MediaRecorder ì¸ìŠ¤í„´ìŠ¤ (ë…¹í™” ì œì–´)
            let isRecording = false;                   // ë…¹í™” ìƒíƒœ í”Œë˜ê·¸
            let recTimer = null;                       // ë…¹í™” ì‹œê°„ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸
            let recStartTime = 0;                     // ë…¹í™” ì‹œì‘ ì‹œê°„ (íƒ€ì„ìŠ¤íƒ¬í”„)
            let audioContext = null;                   // Web Audio API ì»¨í…ìŠ¤íŠ¸ (ì˜¤ë””ì˜¤ ì²˜ë¦¬)
            let gainNodes = { desktop: null, mic: null }; // ì˜¤ë””ì˜¤ ë³¼ë¥¨ ì œì–´ìš© GainNode
            let analysers = { desktop: null, mic: null }; // ê° íŠ¸ë™ë³„ Analyser
            let audioMuted = { desktop: false, mic: false }; // ì˜¤ë””ì˜¤ ìŒì†Œê±° ìƒíƒœ
            let scenes = [{ id: 0, name: 'Scene' }];  // ì¥ë©´ ëª©ë¡ ë°°ì—´
            let currentSceneId = 0;                   // í˜„ì¬ í™œì„± ì¥ë©´ ID
            let sources = [];                          // ì†ŒìŠ¤ ëª©ë¡ ë°°ì—´
            let selectedSourceId = null;               // í˜„ì¬ ì„ íƒëœ ì†ŒìŠ¤ ID
            let nextSourceId = 1;                      // ë‹¤ìŒ ì†ŒìŠ¤ ID (ìë™ ì¦ê°€)
            let backgroundRemovalEnabled = false;      // ë°°ê²½ ì œê±° í™œì„±í™” ìƒíƒœ
            let comparisonMode = false;                 // ì „/í›„ ë¹„êµ ëª¨ë“œ í™œì„±í™” ìƒíƒœ
            
            // ============================================
            // ë¼ì¦ˆë² ë¦¬íŒŒì´ WebSocket ì—°ê²° ë³€ìˆ˜
            // ============================================
            let piWebSocket = null;                    // WebSocket ì—°ê²° ì¸ìŠ¤í„´ìŠ¤
            let piConnected = false;                   // ì—°ê²° ìƒíƒœ í”Œë˜ê·¸
            let piReconnectAttempts = 0;               // ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜
            let piReconnectTimer = null;              // ì¬ì—°ê²° íƒ€ì´ë¨¸
            const MAX_RECONNECT_ATTEMPTS = 5;         // ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜
            const RECONNECT_DELAY = 3000;             // ì¬ì—°ê²° ëŒ€ê¸° ì‹œê°„ (3ì´ˆ)
            let piVideoStream = null;                  // ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ ìˆ˜ì‹ í•œ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼

            // Electron API ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            const isElectron = typeof window.electronAPI !== 'undefined' && typeof window.electronAPI.send === 'function';

            /**
             * ì‚¬ìš© ê°€ëŠ¥í•œ ë¹„ë””ì˜¤/ì˜¤ë””ì˜¤ ì…ë ¥ ì¥ì¹˜ ëª©ë¡ì„ ê°€ì ¸ì™€ ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€í•©ë‹ˆë‹¤.
             */
            async function getDevices() {
                let tempStream = null;
                try {
                    // ê¶Œí•œ íšë“ì„ ìœ„í•´ ì„ì‹œ ìŠ¤íŠ¸ë¦¼ ìš”ì²­ (ì¥ì¹˜ ë¼ë²¨ì„ ì–»ê¸° ìœ„í•´ í•„ìš”)
                    tempStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    
                    // ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    
                    // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
                    videoSelect.innerHTML = '';
                    audioSelect.innerHTML = '';

                    // ê¸°ë³¸ ì˜µì…˜ ì¶”ê°€
                    const videoDefaultOption = document.createElement('option');
                    videoDefaultOption.value = '';
                    videoDefaultOption.text = 'ì¹´ë©”ë¼ ì„ íƒ...';
                    videoSelect.appendChild(videoDefaultOption);

                    const audioDefaultOption = document.createElement('option');
                    audioDefaultOption.value = '';
                    audioDefaultOption.text = 'ë§ˆì´í¬ ì„ íƒ...';
                    audioSelect.appendChild(audioDefaultOption);

                    // ì¥ì¹˜ ëª©ë¡ ì¶”ê°€
                    let videoCount = 0;
                    let audioCount = 0;
                    
                    devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        
                        if (device.kind === 'videoinput') {
                            videoCount++;
                            option.text = device.label || `ì¹´ë©”ë¼ ${videoCount}`;
                            videoSelect.appendChild(option);
                        } else if (device.kind === 'audioinput') {
                            audioCount++;
                            option.text = device.label || `ë§ˆì´í¬ ${audioCount}`;
                            audioSelect.appendChild(option);
                        }
                    });

                    // ì„ì‹œ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                    if (tempStream) {
                        tempStream.getTracks().forEach(track => track.stop());
                    }

                    console.log(`ì¥ì¹˜ ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ì¹´ë©”ë¼ ${videoCount}ê°œ, ë§ˆì´í¬ ${audioCount}ê°œ`);
                    
                    if (videoCount === 0 && audioCount === 0) {
                        console.warn('ì¸ì‹ëœ ì¹´ë©”ë¼/ë§ˆì´í¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (err) {
                    console.error("ì¥ì¹˜ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
                    
                    // ì„ì‹œ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                    if (tempStream) {
                        tempStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    videoSelect.innerHTML = '<option value="">ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</option>';
                    audioSelect.innerHTML = '<option value="">ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</option>';
                }
            }

            // ============================================
            // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê´€ë¦¬ í•¨ìˆ˜
            // ============================================
            
            /**
             * ì„ íƒëœ ë¹„ë””ì˜¤/ì˜¤ë””ì˜¤ ì¥ì¹˜ë¡œ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì„ ì‹œì‘í•©ë‹ˆë‹¤.
             * 
             * @description
             * - ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ì´ ìˆìœ¼ë©´ ëª¨ë“  íŠ¸ë™ì„ ì¤‘ì§€í•©ë‹ˆë‹¤
             * - ì„ íƒëœ ì¥ì¹˜ IDë¡œ ìƒˆ ìŠ¤íŠ¸ë¦¼ì„ ìš”ì²­í•©ë‹ˆë‹¤
             * - ìŠ¤íŠ¸ë¦¼ì„ ë¹„ë””ì˜¤ ìš”ì†Œì— ì—°ê²°í•©ë‹ˆë‹¤
             * - ì˜¤ë””ì˜¤ ì²˜ë¦¬ ë° ë…¹í™”ê¸°ë¥¼ ì¬ì„¤ì •í•©ë‹ˆë‹¤
             * - Studio Modeê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í”„ë¦¬ë·°/í”„ë¡œê·¸ë¨ ìŠ¤íŠ¸ë¦¼ë„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤
             * 
             * @param {string} [videoDeviceId] - ë¹„ë””ì˜¤ ì¥ì¹˜ ID (ì—†ìœ¼ë©´ ê¸°ë³¸ ì¥ì¹˜ ì‚¬ìš©)
             * @param {string} [audioDeviceId] - ì˜¤ë””ì˜¤ ì¥ì¹˜ ID (ì—†ìœ¼ë©´ ê¸°ë³¸ ì¥ì¹˜ ì‚¬ìš©)
             * 
             * @throws {Error} ì¥ì¹˜ ì ‘ê·¼ì´ ê±°ë¶€ë˜ê±°ë‚˜ ì‚¬ìš© ì¤‘ì¸ ê²½ìš°
             */
            async function startStream(videoDeviceId, audioDeviceId) {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }

                // ë¹ˆ ë¬¸ìì—´ì´ë‚˜ undefinedì¼ ë•Œ ê¸°ë³¸ ì¥ì¹˜ ì‚¬ìš©
                const constraints = {
                    video: (videoDeviceId && videoDeviceId.trim()) ? { deviceId: { exact: videoDeviceId } } : true,
                    audio: (audioDeviceId && audioDeviceId.trim()) ? { deviceId: { exact: audioDeviceId } } : true
                };

                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    updateVideoDisplay(mediaStream);
                    
                    setupAudioProcessing(mediaStream);
                    setupMediaRecorder();
                    startRecordingBtn.disabled = false;

                    const videoTrack = mediaStream.getVideoTracks()[0];
                    const audioTrack = mediaStream.getAudioTracks()[0];
                    
                    if (videoTrack) {
                        const currentVideoId = videoTrack.getSettings().deviceId;
                        if (currentVideoId) videoSelect.value = currentVideoId;
                    }
                    if (audioTrack) {
                        const currentAudioId = audioTrack.getSettings().deviceId;
                        if (currentAudioId) audioSelect.value = currentAudioId;
                    }
                } catch (err) {
                    console.error("ë¯¸ë””ì–´ ì¥ì¹˜ ì ‘ê·¼ ì˜¤ë¥˜:", err);
                    videoFeed.style.backgroundColor = '#330000';
                    sourcesContent.innerHTML = `<p style="color: #f44;">ì˜¤ë¥˜: ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ì´<br>ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.</p>`;
                    startRecordingBtn.disabled = true;
                }
            }

            /**
             * ë¹„ë””ì˜¤ í‘œì‹œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤ (ì¼ë°˜ ëª¨ë“œ ë˜ëŠ” ë¹„êµ ëª¨ë“œ).
             * @param {MediaStream} stream - ì—…ë°ì´íŠ¸í•  ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼
             */
            function updateVideoDisplay(stream) {
                const videoFeed = document.getElementById('main-video-feed');
                const comparisonContainer = document.getElementById('comparison-container');
                const originalVideo = document.getElementById('original-video');
                const processedVideo = document.getElementById('processed-video');
                
                if (comparisonMode && comparisonContainer) {
                    // ë¹„êµ ëª¨ë“œ: ì›ë³¸ê³¼ ì²˜ë¦¬ëœ ì˜ìƒì„ ë‚˜ë€íˆ í‘œì‹œ
                    comparisonContainer.classList.add('active');
                    if (videoFeed) videoFeed.style.display = 'none';
                    
                    if (originalVideo) {
                        originalVideo.srcObject = stream.clone();
                    }
                    if (processedVideo) {
                        // TODO: ë°°ê²½ ì œê±° ì²˜ë¦¬ëœ ìŠ¤íŠ¸ë¦¼ì„ processedVideoì— ì—°ê²°
                        // í˜„ì¬ëŠ” ì›ë³¸ê³¼ ë™ì¼í•˜ê²Œ í‘œì‹œ (AI ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ í•„ìš”)
                        processedVideo.srcObject = stream;
                    }
                } else {
                    // ì¼ë°˜ ëª¨ë“œ: ë‹¨ì¼ ë¹„ë””ì˜¤ í‘œì‹œ
                    if (comparisonContainer) comparisonContainer.classList.remove('active');
                    if (videoFeed) {
                        videoFeed.style.display = 'block';
                        videoFeed.srcObject = stream;
                    }
                }
            }

            /**
             * ë°°ê²½ ì œê±° ê¸°ëŠ¥ì„ í† ê¸€í•©ë‹ˆë‹¤.
             */
            function toggleBackgroundRemoval() {
                backgroundRemovalEnabled = !backgroundRemovalEnabled;
                const btn = document.getElementById('toggle-background-removal');
                
                if (btn) {
                    btn.textContent = `ë°°ê²½ ì œê±°: ${backgroundRemovalEnabled ? 'ON' : 'OFF'}`;
                    if (backgroundRemovalEnabled) {
                        btn.classList.add('recording');
                    } else {
                        btn.classList.remove('recording');
                    }
                }
                
                // TODO: ì‹¤ì œ ë°°ê²½ ì œê±° AI ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ í•„ìš”
                console.log('ë°°ê²½ ì œê±°:', backgroundRemovalEnabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”');
                
                if (mediaStream) {
                    updateVideoDisplay(mediaStream);
                }
            }

            /**
             * ì „/í›„ ë¹„êµ ëª¨ë“œë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
             */
            function toggleComparison() {
                comparisonMode = !comparisonMode;
                const btn = document.getElementById('toggle-comparison');
                
                if (btn) {
                    if (comparisonMode) {
                        btn.textContent = 'ì „/í›„ ë¹„êµ ìˆ¨ê¸°ê¸°';
                        btn.classList.add('recording');
                    } else {
                        btn.textContent = 'ì „/í›„ ë¹„êµ ë³´ê¸°';
                        btn.classList.remove('recording');
                    }
                }
                
                if (mediaStream) {
                    updateVideoDisplay(mediaStream);
                }
            }

            /**
             * ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ì²˜ë¦¬í•˜ê³  ë³¼ë¥¨ ë¯¸í„°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
             * Web Audio APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¤ë””ì˜¤ ë¶„ì„ ë° ë³¼ë¥¨ ì œì–´ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
             * @param {MediaStream} stream - ì²˜ë¦¬í•  ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼
             */
            function setupAudioProcessing(stream) {
                const desktopMeter = document.querySelector('[data-meter-name="desktop"]');
                const micMeter = document.querySelector('[data-meter-name="mic"]');

                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                }

                audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                
                // ê° íŠ¸ë™ë³„ë¡œ ë³„ë„ì˜ GainNodeì™€ Analyser ìƒì„±
                gainNodes.mic = audioContext.createGain();
                gainNodes.desktop = audioContext.createGain();
                gainNodes.mic.gain.value = 1.0;
                gainNodes.desktop.gain.value = 1.0;
                
                // Micìš© Analyser
                analysers.mic = audioContext.createAnalyser();
                analysers.mic.fftSize = 256;
                
                // Desktopìš© Analyser
                analysers.desktop = audioContext.createAnalyser();
                analysers.desktop.fftSize = 256;
                
                // ì˜¤ë””ì˜¤ ì—°ê²°: source -> ê° gainNode -> ê° analyser -> destination
                source.connect(gainNodes.mic);
                source.connect(gainNodes.desktop);
                gainNodes.mic.connect(analysers.mic);
                gainNodes.desktop.connect(analysers.desktop);
                analysers.mic.connect(audioContext.destination);
                analysers.desktop.connect(audioContext.destination);

                const micBufferLength = analysers.mic.frequencyBinCount;
                const micDataArray = new Uint8Array(micBufferLength);
                
                const desktopBufferLength = analysers.desktop.frequencyBinCount;
                const desktopDataArray = new Uint8Array(desktopBufferLength);

                function updateMeter() {
                    if (!audioContext) return;

                    // Mic ë¯¸í„° ì—…ë°ì´íŠ¸
                    if (analysers.mic && !audioMuted.mic) {
                        analysers.mic.getByteTimeDomainData(micDataArray);
                        let micMaxVal = 0;
                        for (let i = 0; i < micBufferLength; i++) {
                            const v = Math.abs(micDataArray[i] - 128);
                            if (v > micMaxVal) {
                                micMaxVal = v;
                            }
                        }
                        const micVolumePercent = (micMaxVal / 128) * 100;
                        if (micMeter) micMeter.style.width = micVolumePercent + '%';
                    } else {
                        if (micMeter) micMeter.style.width = '0%';
                    }

                    // Desktop ë¯¸í„° ì—…ë°ì´íŠ¸
                    if (analysers.desktop && !audioMuted.desktop) {
                        analysers.desktop.getByteTimeDomainData(desktopDataArray);
                        let desktopMaxVal = 0;
                        for (let i = 0; i < desktopBufferLength; i++) {
                            const v = Math.abs(desktopDataArray[i] - 128);
                            if (v > desktopMaxVal) {
                                desktopMaxVal = v;
                            }
                        }
                        const desktopVolumePercent = (desktopMaxVal / 128) * 100;
                        if (desktopMeter) desktopMeter.style.width = desktopVolumePercent + '%';
                    } else {
                        if (desktopMeter) desktopMeter.style.width = '0%';
                    }

                    requestAnimationFrame(updateMeter);
                }
                updateMeter();
            }

            /**
             * ì˜¤ë””ì˜¤ íŠ¸ë™ì˜ ë³¼ë¥¨ì„ ì„¤ì •í•©ë‹ˆë‹¤.
             * @param {string} trackType - íŠ¸ë™ íƒ€ì… ('desktop' ë˜ëŠ” 'mic')
             * @param {number} dbValue - ë°ì‹œë²¨ ê°’ (-100 ~ 0)
             */
            function setVolume(trackType, dbValue) {
                if (!gainNodes[trackType]) return;
                
                const gain = dbValue === -100 ? 0 : Math.pow(10, dbValue / 20);
                gainNodes[trackType].gain.value = gain;
                
                const dbDisplay = document.querySelector(`[data-track="${trackType}"] .db-display`);
                if (dbDisplay) {
                    dbDisplay.textContent = `${dbValue.toFixed(1)} dB`;
                }
            }

            /**
             * ì˜¤ë””ì˜¤ íŠ¸ë™ì˜ ìŒì†Œê±° ìƒíƒœë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
             * @param {string} trackType - íŠ¸ë™ íƒ€ì… ('desktop' ë˜ëŠ” 'mic')
             */
            function toggleMute(trackType) {
                if (!gainNodes[trackType]) {
                    console.error(`GainNodeë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${trackType}`);
                    return;
                }
                
                audioMuted[trackType] = !audioMuted[trackType];
                const muteBtn = document.querySelector(`[data-mute="${trackType}"]`);
                const slider = document.querySelector(`[data-volume="${trackType}"]`);
                
                console.log(`${trackType} ìŒì†Œê±° í† ê¸€: ${audioMuted[trackType]}`);
                
                if (audioMuted[trackType]) {
                    gainNodes[trackType].gain.value = 0;
                    if (muteBtn) {
                        muteBtn.textContent = 'ğŸ”‡';
                        muteBtn.style.opacity = '1';
                        muteBtn.setAttribute('data-muted', 'true');
                    }
                } else {
                    const dbValue = parseFloat(slider.value);
                    setVolume(trackType, dbValue);
                    if (muteBtn) {
                        muteBtn.textContent = 'ğŸ”Š';
                        muteBtn.style.opacity = '0.5';
                        muteBtn.setAttribute('data-muted', 'false');
                    }
                }
            }

            /**
             * ì˜¤ë””ì˜¤ ë¯¹ì„œ ì»¨íŠ¸ë¡¤(ë³¼ë¥¨ ìŠ¬ë¼ì´ë”, ìŒì†Œê±° ë²„íŠ¼)ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
             */
            function setupAudioMixerControls() {
                document.querySelectorAll('.volume-slider').forEach(slider => {
                    slider.addEventListener('input', (e) => {
                        const trackType = e.target.dataset.volume;
                        const dbValue = parseFloat(e.target.value);
                        
                        if (!audioMuted[trackType]) {
                            setVolume(trackType, dbValue);
                        }
                    });
                });

                document.querySelectorAll('.mute-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const trackType = e.target.dataset.mute;
                        toggleMute(trackType);
                    });
                });
            }

            /**
             * MediaRecorderë¥¼ ì´ˆê¸°í™”í•˜ê³  ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
             */
            function setupMediaRecorder() {
                if (!mediaStream) return;

                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }

                try {
                    mediaRecorder = new MediaRecorder(mediaStream, {
                        mimeType: 'video/webm; codecs=vp9,opus'
                    });
                } catch (e) {
                    console.warn("VP9 ë¯¸ì§€ì›, ê¸°ë³¸ ì½”ë±ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.");
                    mediaRecorder = new MediaRecorder(mediaStream);
                }

                mediaRecorder.ondataavailable = async (event) => {
                    if (event.data.size > 0 && isElectron) {
                        const buffer = await event.data.arrayBuffer();
                        window.electronAPI.send('video-chunk', new Uint8Array(buffer));
                    }
                };

                mediaRecorder.onstart = () => {
                    if (isElectron) window.electronAPI.send('start-recording');
                    
                    startRecordingBtn.textContent = 'Stop Recording';
                    startRecordingBtn.classList.add('recording');
                    isRecording = true;
                    
                    recStartTime = Date.now();
                    recStatus.classList.add('recording');
                    recTimer = setInterval(updateRecTimer, 1000);
                };

                mediaRecorder.onstop = () => {
                    if (isElectron) window.electronAPI.send('stop-recording');
                    
                    startRecordingBtn.textContent = 'Start Recording';
                    startRecordingBtn.classList.remove('recording');
                    isRecording = false;
                    
                    clearInterval(recTimer);
                    recStatus.classList.remove('recording');
                    recStatus.textContent = 'REC: 00:00:00';
                };
            }

            startRecordingBtn.addEventListener('click', () => {
                if (!mediaRecorder) {
                    console.error("MediaRecorder ì´ˆê¸°í™” ì‹¤íŒ¨");
                    return;
                }
                if (isRecording) {
                    mediaRecorder.stop();
                } else {
                    mediaRecorder.start(1000);
                }
            });

            /**
             * ë…¹í™” íƒ€ì´ë¨¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ê²½ê³¼ ì‹œê°„ì„ í‘œì‹œí•©ë‹ˆë‹¤.
             */
            function updateRecTimer() {
                const seconds = Math.floor((Date.now() - recStartTime) / 1000);
                const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                recStatus.textContent = `REC: ${h}:${m}:${s}`;
            }

            videoSelect.addEventListener('change', (e) => {
                const selectedVideoId = e.target.value;
                const selectedAudioId = audioSelect.value;
                startStream(selectedVideoId, selectedAudioId);
                saveSettings(); // ì„¤ì • ë³€ê²½ ì‹œ ìë™ ì €ì¥
            });

            audioSelect.addEventListener('change', (e) => {
                const selectedAudioId = e.target.value;
                const selectedVideoId = videoSelect.value;
                startStream(selectedVideoId, selectedAudioId);
                saveSettings(); // ì„¤ì • ë³€ê²½ ì‹œ ìë™ ì €ì¥
            });


            // ============================================
            // ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
            // ============================================
            
            /**
             * ì„¤ì •ì„ localStorageì— ì €ì¥í•©ë‹ˆë‹¤.
             */
            function saveSettings() {
                try {
                    const settings = {
                        videoSource: videoSelect.value,
                        audioSource: audioSelect.value,
                        raspberryPiIp: document.getElementById('raspberry-pi-ip')?.value || '',
                        raspberryPiPort: document.getElementById('raspberry-pi-port')?.value || '8765',
                        fileFormat: document.getElementById('file-format')?.value || 'webm',
                        savePath: document.getElementById('save-path-display')?.value || 'C:\\VideoRecoding',
                        timestamp: Date.now()
                    };
                    localStorage.setItem('spotlightCamSettings', JSON.stringify(settings));
                    console.log('ì„¤ì • ì €ì¥ ì™„ë£Œ:', settings);
                } catch (error) {
                    console.error('ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
                }
            }
            
            /**
             * localStorageì—ì„œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
             */
            function loadSettings() {
                try {
                    const saved = localStorage.getItem('spotlightCamSettings');
                    if (!saved) return null;
                    
                    const settings = JSON.parse(saved);
                    console.log('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°:', settings);
                    
                    // ì„¤ì • ì ìš©
                    if (settings.videoSource && videoSelect) {
                        videoSelect.value = settings.videoSource;
                    }
                    if (settings.audioSource && audioSelect) {
                        audioSelect.value = settings.audioSource;
                    }
                    if (settings.raspberryPiIp) {
                        const piIpInput = document.getElementById('raspberry-pi-ip');
                        if (piIpInput) piIpInput.value = settings.raspberryPiIp;
                    }
                    if (settings.raspberryPiPort) {
                        const piPortInput = document.getElementById('raspberry-pi-port');
                        if (piPortInput) piPortInput.value = settings.raspberryPiPort;
                    }
                    if (settings.fileFormat) {
                        const fileFormatSelect = document.getElementById('file-format');
                        if (fileFormatSelect) fileFormatSelect.value = settings.fileFormat;
                    }
                    
                    return settings;
                } catch (error) {
                    console.error('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    return null;
                }
            }

            const openSettingsBtn = document.getElementById('open-settings');
            const closeSettingsBtn = document.getElementById('close-settings');
            const settingsModal = document.getElementById('settings-modal');
            const setSavePathBtn = document.getElementById('set-save-path');
            const savePathDisplay = document.getElementById('save-path-display');
            
            openSettingsBtn.addEventListener('click', async () => {
                settingsModal.classList.add('visible');
                
                // ì„¤ì • ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì¥ì¹˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await getDevices();
                
                // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                const savedSettings = loadSettings();
                
                if (isElectron && window.electronAPI.invoke) {
                    try {
                        const currentPath = await window.electronAPI.invoke('get-save-path');
                        if (savePathDisplay) {
                            savePathDisplay.value = savedSettings?.savePath || currentPath || 'C:\\VideoRecoding';
                        }
                    } catch (err) {
                        console.error('ì €ì¥ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
                        if (savePathDisplay) {
                            savePathDisplay.value = savedSettings?.savePath || 'C:\\VideoRecoding';
                        }
                    }
                } else {
                    if (savePathDisplay) {
                        savePathDisplay.value = savedSettings?.savePath || 'C:\\VideoRecoding';
                    }
                }
            });
            
            closeSettingsBtn.addEventListener('click', () => {
                // ë‹«ê¸° ì „ì— ì„¤ì • ì €ì¥
                saveSettings();
                settingsModal.classList.remove('visible');
            });

            setSavePathBtn.addEventListener('click', async () => {
                if (isElectron && window.electronAPI.invoke) {
                    try {
                        const selectedPath = await window.electronAPI.invoke('select-save-path');
                        if (selectedPath && savePathDisplay) {
                            savePathDisplay.value = selectedPath;
                            saveSettings(); // ì €ì¥ ê²½ë¡œ ë³€ê²½ ì‹œ ìë™ ì €ì¥
                        }
                    } catch (err) {
                        console.error('ì €ì¥ ê²½ë¡œ ì„ íƒ ì‹¤íŒ¨:', err);
                    }
                } else {
                    alert('Electron í™˜ê²½ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
            });
            
            // ë‹¤ë¥¸ ì„¤ì • í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì €ì¥
            const piIpInput = document.getElementById('raspberry-pi-ip');
            const piPortInput = document.getElementById('raspberry-pi-port');
            const fileFormatSelect = document.getElementById('file-format');
            
            if (piIpInput) {
                piIpInput.addEventListener('change', saveSettings);
                piIpInput.addEventListener('blur', saveSettings);
            }
            if (piPortInput) {
                piPortInput.addEventListener('change', saveSettings);
                piPortInput.addEventListener('blur', saveSettings);
            }
            if (fileFormatSelect) {
                fileFormatSelect.addEventListener('change', saveSettings);
            }

            const openTransitionsBtn = document.getElementById('open-transitions-settings');
            const closeTransitionsBtn = document.getElementById('close-transitions-settings');
            const applyTransitionsBtn = document.getElementById('apply-transition-settings');
            const transitionsModal = document.getElementById('transitions-settings-modal');
            const durationInput = document.getElementById('fade-duration');
            const durationText = document.getElementById('duration-text');
            
            openTransitionsBtn.addEventListener('click', () => transitionsModal.classList.add('visible'));
            closeTransitionsBtn.addEventListener('click', () => transitionsModal.classList.remove('visible'));
            applyTransitionsBtn.addEventListener('click', () => {
                durationText.textContent = `${durationInput.value} ms`;
                transitionsModal.classList.remove('visible');
            });

            const exitButton = document.getElementById('exit-button');
            const menuExitButton = document.getElementById('menu-exit');
            const exitFunc = () => {
                if (isElectron) {
                    window.electronAPI.send('exit-app');
                } else {
                    alert("í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. (ëª©ì—…)");
                }
            };
            exitButton.addEventListener('click', exitFunc);
            menuExitButton.addEventListener('click', exitFunc);

            const menuEvents = ['menu-copy', 'menu-paste', 'menu-toggle-fullscreen', 'menu-reload', 'menu-toggle-devtools'];
            menuEvents.forEach(evt => {
                document.getElementById(evt)?.addEventListener('click', () => {
                    if (isElectron) window.electronAPI.send(evt);
                });
            });

            // ë°°ê²½ ì œê±° ë° ë¹„êµ ëª¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
            const toggleBackgroundRemovalBtn = document.getElementById('toggle-background-removal');
            const toggleComparisonBtn = document.getElementById('toggle-comparison');
            
            if (toggleBackgroundRemovalBtn) {
                toggleBackgroundRemovalBtn.addEventListener('click', toggleBackgroundRemoval);
            }
            
            if (toggleComparisonBtn) {
                toggleComparisonBtn.addEventListener('click', toggleComparison);
            }

            /**
             * ë…¹í™” íŒŒì¼ ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤.
             */
            function showRecordings() {
                if (isElectron && window.electronAPI.invoke) {
                    window.electronAPI.invoke('show-recordings').then(files => {
                        if (files && files.length > 0) {
                            const fileList = files.map(f => `â€¢ ${f}`).join('\n');
                            alert(`ë…¹í™” íŒŒì¼ ëª©ë¡:\n\n${fileList}`);
                        } else {
                            alert('ì €ì¥ëœ ë…¹í™” íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    }).catch(err => {
                        console.error('ë…¹í™” íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
                        alert('ë…¹í™” íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    });
                } else {
                    alert('Electron í™˜ê²½ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
            }

            const menuShowRecordings = document.getElementById('menu-show-recordings');
            const menuSettings = document.getElementById('menu-settings');
            const menuCheckUpdates = document.getElementById('menu-check-updates');
            const menuAbout = document.getElementById('menu-about');
            
            if (menuShowRecordings) menuShowRecordings.addEventListener('click', showRecordings);
            if (menuSettings) menuSettings.addEventListener('click', () => {
                document.getElementById('open-settings')?.click();
            });
            if (menuCheckUpdates) menuCheckUpdates.addEventListener('click', checkForUpdatesManually);
            if (menuAbout) menuAbout.addEventListener('click', () => {
                alert('Spotlight Cam v' + (isElectron ? require('electron').remote?.app?.getVersion() || '1.0.0' : '1.0.0') + '\n\ní¬ë¡œë§ˆí‚¤ë¥¼ ëŒ€ì²´í•˜ëŠ” AI ê°ì²´ ì¶”ì  ë° ë°°ê²½ ì œê±° ì‹œìŠ¤í…œ\n\níŒ€: Anywhere Studio');
            });

            /**
             * ì¥ë©´ ëª©ë¡ì„ UIì— ë Œë”ë§í•©ë‹ˆë‹¤.
             */
            function renderScenes() {
                const scenesList = document.getElementById('scenes-list');
                if (!scenesList) return;
                
                scenesList.innerHTML = '';
                scenes.forEach((scene) => {
                    const li = document.createElement('li');
                    li.className = 'scene-item';
                    li.dataset.sceneId = scene.id;
                    li.textContent = scene.name;
                    if (scene.id === currentSceneId) {
                        li.classList.add('active');
                    }
                    li.addEventListener('click', () => switchScene(scene.id));
                    scenesList.appendChild(li);
                });
            }

            /**
             * Scene ì¶”ê°€ ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
             */
            function openAddSceneModal() {
                const modal = document.getElementById('add-scene-modal');
                const sceneNameInput = document.getElementById('scene-name-input');
                
                if (modal) {
                    modal.classList.add('visible');
                    // ê¸°ë³¸ ì¥ë©´ ì´ë¦„ ì„¤ì •
                    if (sceneNameInput) {
                        sceneNameInput.value = `Scene ${scenes.length + 1}`;
                        sceneNameInput.focus();
                        sceneNameInput.select();
                    }
                } else {
                    console.error('Scene ì¶”ê°€ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                }
            }
            
            /**
             * Scene ì¶”ê°€ ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
             */
            function closeAddSceneModal() {
                const modal = document.getElementById('add-scene-modal');
                const sceneNameInput = document.getElementById('scene-name-input');
                
                if (modal) modal.classList.remove('visible');
                if (sceneNameInput) sceneNameInput.value = '';
            }
            
            /**
             * ìƒˆ ì¥ë©´ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
             */
            function addScene() {
                console.log('addScene í•¨ìˆ˜ í˜¸ì¶œë¨');
                const sceneNameInput = document.getElementById('scene-name-input');
                const sceneName = sceneNameInput?.value?.trim();
                
                if (!sceneName) {
                    alert('ì¥ë©´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    if (sceneNameInput) sceneNameInput.focus();
                    return;
                }
                
                const newId = Math.max(...scenes.map(s => s.id), -1) + 1;
                scenes.push({ id: newId, name: sceneName });
                renderScenes();
                switchScene(newId);
                closeAddSceneModal();
                console.log(`ìƒˆ ì¥ë©´ ì¶”ê°€ë¨: ${sceneName} (ID: ${newId})`);
            }

            /**
             * í˜„ì¬ í™œì„± ì¥ë©´ì„ ì‚­ì œí•©ë‹ˆë‹¤.
             */
            function removeScene() {
                if (scenes.length <= 1) {
                    alert('ìµœì†Œ í•˜ë‚˜ì˜ ì¥ë©´ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }
                
                const sceneIndex = scenes.findIndex(s => s.id === currentSceneId);
                if (sceneIndex === -1) return;
                
                scenes.splice(sceneIndex, 1);
                
                if (sceneIndex >= scenes.length) {
                    currentSceneId = scenes[scenes.length - 1].id;
                } else {
                    currentSceneId = scenes[sceneIndex].id;
                }
                
                renderScenes();
            }

            /**
             * í˜„ì¬ ì¥ë©´ì„ ëª©ë¡ì—ì„œ ìœ„ë¡œ ì´ë™í•©ë‹ˆë‹¤.
             */
            function moveSceneUp() {
                const sceneIndex = scenes.findIndex(s => s.id === currentSceneId);
                if (sceneIndex <= 0) return;
                
                [scenes[sceneIndex - 1], scenes[sceneIndex]] = [scenes[sceneIndex], scenes[sceneIndex - 1]];
                renderScenes();
            }

            /**
             * í˜„ì¬ ì¥ë©´ì„ ëª©ë¡ì—ì„œ ì•„ë˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.
             */
            function moveSceneDown() {
                const sceneIndex = scenes.findIndex(s => s.id === currentSceneId);
                if (sceneIndex >= scenes.length - 1) return;
                
                [scenes[sceneIndex], scenes[sceneIndex + 1]] = [scenes[sceneIndex + 1], scenes[sceneIndex]];
                renderScenes();
            }

            /**
             * ì§€ì •ëœ ì¥ë©´ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.
             * @param {number} sceneId - ì „í™˜í•  ì¥ë©´ ID
             */
            function switchScene(sceneId) {
                const scene = scenes.find(s => s.id === sceneId);
                if (!scene) return;
                
                currentSceneId = sceneId;
                renderScenes();
                console.log(`ì¥ë©´ ì „í™˜: ${scene.name}`);
            }

            /**
             * ì¥ë©´ íŒ¨ë„ì˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
             */
            function setupScenesPanel() {
                const addBtn = document.getElementById('add-scene-btn');
                const removeBtn = document.getElementById('remove-scene-btn');
                const moveUpBtn = document.getElementById('move-scene-up-btn');
                const moveDownBtn = document.getElementById('move-scene-down-btn');
                
                // Scene ì¶”ê°€ ëª¨ë‹¬ ë²„íŠ¼ ì´ë²¤íŠ¸
                const addSceneConfirmBtn = document.getElementById('add-scene-confirm');
                const cancelAddSceneBtn = document.getElementById('cancel-add-scene');
                const sceneNameInput = document.getElementById('scene-name-input');
                
                if (addBtn) {
                    console.log('Scene ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
                    addBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Scene ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨');
                        openAddSceneModal();
                    });
                } else {
                    console.error('Scene ì¶”ê°€ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                }
                
                if (addSceneConfirmBtn) {
                    addSceneConfirmBtn.addEventListener('click', () => {
                        addScene();
                    });
                }
                
                if (cancelAddSceneBtn) {
                    cancelAddSceneBtn.addEventListener('click', () => {
                        closeAddSceneModal();
                    });
                }
                
                // Enter í‚¤ë¡œ ì¥ë©´ ì¶”ê°€
                if (sceneNameInput) {
                    sceneNameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            addScene();
                        }
                    });
                }
                
                if (removeBtn) removeBtn.addEventListener('click', removeScene);
                if (moveUpBtn) moveUpBtn.addEventListener('click', moveSceneUp);
                if (moveDownBtn) moveDownBtn.addEventListener('click', moveSceneDown);
                
                renderScenes();
            }

            /**
             * ì†ŒìŠ¤ ëª©ë¡ì„ UIì— ë Œë”ë§í•©ë‹ˆë‹¤.
             */
            function renderSources() {
                const sourcesList = document.getElementById('sources-list');
                const sourcesEmpty = document.getElementById('sources-empty');
                
                if (!sourcesList) return;
                
                sourcesList.innerHTML = '';
                
                if (sources.length === 0) {
                    sourcesList.style.display = 'none';
                    if (sourcesEmpty) sourcesEmpty.style.display = 'block';
                } else {
                    sourcesList.style.display = 'block';
                    if (sourcesEmpty) sourcesEmpty.style.display = 'none';
                    
                    sources.forEach((source) => {
                        const li = document.createElement('li');
                        li.className = 'source-item';
                        li.dataset.sourceId = source.id;
                        if (source.id === selectedSourceId) {
                            li.classList.add('selected');
                        }
                        
                        const icon = document.createElement('span');
                        icon.className = 'source-icon';
                        if (source.type === 'video') icon.textContent = 'ğŸ“¹';
                        else if (source.type === 'image') icon.textContent = 'ğŸ–¼ï¸';
                        else if (source.type === 'text') icon.textContent = 'ğŸ“';
                        
                        const name = document.createElement('span');
                        name.className = 'source-name';
                        name.textContent = source.name;
                        
                        li.appendChild(icon);
                        li.appendChild(name);
                        li.addEventListener('click', () => selectSource(source.id));
                        sourcesList.appendChild(li);
                    });
                }
            }

            /**
             * ì†ŒìŠ¤ ì¶”ê°€ ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
             */
            function openAddSourceModal() {
                const modal = document.getElementById('add-source-modal');
                const videoOption = document.getElementById('video-option');
                const imageOption = document.getElementById('image-option');
                const textOption = document.getElementById('text-option');
                const sourceVideoDevice = document.getElementById('source-video-device');
                
                // ë¹„ë””ì˜¤ ì¥ì¹˜ ëª©ë¡ ì±„ìš°ê¸°
                if (sourceVideoDevice) {
                    sourceVideoDevice.innerHTML = '';
                    videoSelect.querySelectorAll('option').forEach(option => {
                        const newOption = option.cloneNode(true);
                        sourceVideoDevice.appendChild(newOption);
                    });
                }
                
                // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸
                document.querySelectorAll('input[name="source-type"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const type = e.target.value;
                        if (videoOption) videoOption.style.display = type === 'video' ? 'flex' : 'none';
                        if (imageOption) imageOption.style.display = type === 'image' ? 'flex' : 'none';
                        if (textOption) textOption.style.display = type === 'text' ? 'flex' : 'none';
                    });
                });
                
                if (modal) modal.classList.add('visible');
            }

            /**
             * ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
             */
            function addSource() {
                const sourceType = document.querySelector('input[name="source-type"]:checked')?.value;
                const sourceName = document.getElementById('source-name')?.value || `Source ${nextSourceId}`;
                
                if (!sourceType) return;
                
                let sourceData = {};
                
                if (sourceType === 'video') {
                    const deviceId = document.getElementById('source-video-device')?.value;
                    if (!deviceId) {
                        alert('ë¹„ë””ì˜¤ ì¥ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }
                    sourceData = { type: 'video', deviceId: deviceId };
                } else if (sourceType === 'image') {
                    const fileInput = document.getElementById('source-image-file');
                    if (!fileInput?.files?.[0]) {
                        alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        sourceData = { type: 'image', imageUrl: e.target.result, fileName: file.name };
                        finishAddSource(sourceName, sourceData);
                    };
                    reader.readAsDataURL(file);
                    return;
                } else if (sourceType === 'text') {
                    const textContent = document.getElementById('source-text-content')?.value;
                    if (!textContent) {
                        alert('í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                        return;
                    }
                    sourceData = { type: 'text', content: textContent };
                }
                
                finishAddSource(sourceName, sourceData);
            }

            /**
             * ì†ŒìŠ¤ ì¶”ê°€ë¥¼ ì™„ë£Œí•©ë‹ˆë‹¤.
             */
            function finishAddSource(name, data) {
                const newSource = {
                    id: nextSourceId++,
                    name: name,
                    ...data
                };
                sources.push(newSource);
                renderSources();
                closeAddSourceModal();
            }

            /**
             * ì†ŒìŠ¤ ì¶”ê°€ ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
             */
            function closeAddSourceModal() {
                const modal = document.getElementById('add-source-modal');
                if (modal) modal.classList.remove('visible');
                document.getElementById('source-name').value = '';
                document.getElementById('source-text-content').value = '';
                document.getElementById('source-image-file').value = '';
            }

            /**
             * ì†ŒìŠ¤ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
             */
            function selectSource(sourceId) {
                selectedSourceId = sourceId;
                renderSources();
            }

            /**
             * ì„ íƒëœ ì†ŒìŠ¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
             */
            function removeSource() {
                if (selectedSourceId === null) {
                    alert('ì‚­ì œí•  ì†ŒìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                    return;
                }
                
                const index = sources.findIndex(s => s.id === selectedSourceId);
                if (index !== -1) {
                    sources.splice(index, 1);
                    selectedSourceId = null;
                    renderSources();
                }
            }

            /**
             * ì„ íƒëœ ì†ŒìŠ¤ë¥¼ ìœ„ë¡œ ì´ë™í•©ë‹ˆë‹¤.
             */
            function moveSourceUp() {
                if (selectedSourceId === null) return;
                
                const index = sources.findIndex(s => s.id === selectedSourceId);
                if (index <= 0) return;
                
                [sources[index - 1], sources[index]] = [sources[index], sources[index - 1]];
                renderSources();
            }

            /**
             * ì„ íƒëœ ì†ŒìŠ¤ë¥¼ ì•„ë˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.
             */
            function moveSourceDown() {
                if (selectedSourceId === null) return;
                
                const index = sources.findIndex(s => s.id === selectedSourceId);
                if (index >= sources.length - 1) return;
                
                [sources[index], sources[index + 1]] = [sources[index + 1], sources[index]];
                renderSources();
            }

            /**
             * ì†ŒìŠ¤ íŒ¨ë„ì˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
             */
            function setupSourcesPanel() {
                const addBtn = document.getElementById('add-source-btn');
                const removeBtn = document.getElementById('remove-source-btn');
                const settingsBtn = document.getElementById('source-settings-btn');
                const moveUpBtn = document.getElementById('move-source-up-btn');
                const moveDownBtn = document.getElementById('move-source-down-btn');
                const addSourceModal = document.getElementById('add-source-modal');
                const addSourceConfirm = document.getElementById('add-source-confirm');
                const cancelAddSource = document.getElementById('cancel-add-source');
                
                if (addBtn) addBtn.addEventListener('click', openAddSourceModal);
                if (removeBtn) removeBtn.addEventListener('click', removeSource);
                if (settingsBtn) settingsBtn.addEventListener('click', () => {
                    if (selectedSourceId === null) {
                        alert('ì„¤ì •í•  ì†ŒìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                    } else {
                        alert('ì†ŒìŠ¤ ì„¤ì • ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
                    }
                });
                if (moveUpBtn) moveUpBtn.addEventListener('click', moveSourceUp);
                if (moveDownBtn) moveDownBtn.addEventListener('click', moveSourceDown);
                if (addSourceConfirm) addSourceConfirm.addEventListener('click', addSource);
                if (cancelAddSource) cancelAddSource.addEventListener('click', closeAddSourceModal);
                
                renderSources();
            }

            // ============================================
            // ë¼ì¦ˆë² ë¦¬íŒŒì´ WebSocket ì—°ê²° ê´€ë¦¬ í•¨ìˆ˜
            // ============================================
            
            /**
             * ë¼ì¦ˆë² ë¦¬íŒŒì´ì— WebSocket ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.
             * 
             * @description
             * - ì‚¬ìš©ìê°€ ì…ë ¥í•œ IP ì£¼ì†Œì™€ í¬íŠ¸ë¡œ WebSocket ì—°ê²°ì„ ìƒì„±í•©ë‹ˆë‹¤
             * - ì—°ê²° ì„±ê³µ ì‹œ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ ì„ ì‹œì‘í•©ë‹ˆë‹¤
             * - ì—°ê²° ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤
             * - ì—°ê²° ìƒíƒœë¥¼ UIì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤
             * 
             * @param {string} ip - ë¼ì¦ˆë² ë¦¬íŒŒì´ IP ì£¼ì†Œ
             * @param {number} port - WebSocket í¬íŠ¸ ë²ˆí˜¸ (ê¸°ë³¸: 8765)
             */
            function connectToRaspberryPi(ip, port = 8765) {
                if (piWebSocket && piWebSocket.readyState === WebSocket.OPEN) {
                    console.log('ì´ë¯¸ ë¼ì¦ˆë² ë¦¬íŒŒì´ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const wsUrl = `ws://${ip}:${port}`;
                console.log(`ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ì‹œë„: ${wsUrl}`);

                try {
                    piWebSocket = new WebSocket(wsUrl);

                    piWebSocket.onopen = () => {
                        console.log('ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ì„±ê³µ');
                        piConnected = true;
                        piReconnectAttempts = 0;
                        updatePiConnectionStatus(true);
                        
                        piWebSocket.send(JSON.stringify({
                            type: 'client_ready',
                            message: 'Electron í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë¨'
                        }));
                    };

                    piWebSocket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            handlePiMessage(data);
                        } catch (err) {
                            handlePiVideoFrame(event.data);
                        }
                    };

                    piWebSocket.onclose = (event) => {
                        console.log('ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ì¢…ë£Œ', event.code, event.reason);
                        piConnected = false;
                        updatePiConnectionStatus(false);
                        
                        if (event.code !== 1000 && piReconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                            attemptReconnect(ip, port);
                        }
                    };

                    piWebSocket.onerror = (error) => {
                        console.error('ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ì˜¤ë¥˜:', error);
                        piConnected = false;
                        updatePiConnectionStatus(false);
                    };

                } catch (error) {
                    console.error('WebSocket ìƒì„± ì‹¤íŒ¨:', error);
                    updatePiConnectionStatus(false);
                }
            }

            /**
             * ë¼ì¦ˆë² ë¦¬íŒŒì´ WebSocket ì—°ê²°ì„ í•´ì œí•©ë‹ˆë‹¤.
             */
            function disconnectFromRaspberryPi() {
                if (piWebSocket) {
                    piWebSocket.close(1000, 'ì‚¬ìš©ì ìš”ì²­ìœ¼ë¡œ ì—°ê²° ì¢…ë£Œ');
                    piWebSocket = null;
                }
                piConnected = false;
                piReconnectAttempts = 0;
                if (piReconnectTimer) {
                    clearTimeout(piReconnectTimer);
                    piReconnectTimer = null;
                }
                updatePiConnectionStatus(false);
                
                if (piVideoStream) {
                    piVideoStream = null;
                    if (mediaStream) {
                        videoFeed.srcObject = mediaStream;
                    }
                }
            }

            /**
             * ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ì¬ì‹œë„ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
             */
            function attemptReconnect(ip, port) {
                piReconnectAttempts++;
                console.log(`ì¬ì—°ê²° ì‹œë„ ${piReconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`);
                
                updatePiConnectionStatus(false, `ì¬ì—°ê²° ì‹œë„ ì¤‘... (${piReconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                
                piReconnectTimer = setTimeout(() => {
                    connectToRaspberryPi(ip, port);
                }, RECONNECT_DELAY);
            }

            /**
             * ë¼ì¦ˆë² ë¦¬íŒŒì´ë¡œë¶€í„° ìˆ˜ì‹ í•œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
             */
            function handlePiMessage(data) {
                switch (data.type) {
                    case 'video_frame':
                        handlePiVideoFrame(data.frame);
                        break;
                    case 'motor_status':
                        console.log('ëª¨í„° ìƒíƒœ:', data.status);
                        break;
                    case 'system_info':
                        console.log('ì‹œìŠ¤í…œ ì •ë³´:', data.info);
                        break;
                    default:
                        console.log('ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:', data.type);
                }
            }

            /**
             * ë¼ì¦ˆë² ë¦¬íŒŒì´ë¡œë¶€í„° ìˆ˜ì‹ í•œ ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
             */
            function handlePiVideoFrame(frameData) {
                if (!frameData) return;

                try {
                    if (typeof frameData === 'string') {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            canvas.toBlob((blob) => {
                                const url = URL.createObjectURL(blob);
                                if (videoFeed) {
                                    videoFeed.src = url;
                                }
                            }, 'image/jpeg');
                        };
                        img.src = `data:image/jpeg;base64,${frameData}`;
                    } 
                    else if (frameData instanceof Blob) {
                        const url = URL.createObjectURL(frameData);
                        if (videoFeed) {
                            videoFeed.src = url;
                        }
                    }
                } catch (error) {
                    console.error('ë¹„ë””ì˜¤ í”„ë ˆì„ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                }
            }

            /**
             * ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ìƒíƒœë¥¼ UIì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
             */
            function updatePiConnectionStatus(connected, message) {
                const statusIndicator = document.getElementById('pi-status-indicator');
                const statusText = document.getElementById('pi-status-text');
                const connectionStatus = document.getElementById('pi-connection-status');
                const connectBtn = document.getElementById('connect-pi-btn');
                const disconnectBtn = document.getElementById('disconnect-pi-btn');

                if (connected) {
                    if (statusIndicator) {
                        statusIndicator.style.backgroundColor = 'var(--color-success)';
                        statusIndicator.classList.remove('disconnected');
                        statusIndicator.classList.add('connected');
                    }
                    if (statusText) {
                        statusText.textContent = 'ë¼ì¦ˆë² ë¦¬íŒŒì´: ì—°ê²°ë¨';
                    }
                    if (connectionStatus) {
                        connectionStatus.textContent = 'ì—°ê²°ë¨';
                        connectionStatus.style.backgroundColor = 'var(--color-success)';
                        connectionStatus.style.color = 'white';
                    }
                    if (connectBtn) connectBtn.style.display = 'none';
                    if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
                } else {
                    if (statusIndicator) {
                        statusIndicator.style.backgroundColor = 'var(--color-danger)';
                        statusIndicator.classList.remove('connected');
                        statusIndicator.classList.add('disconnected');
                    }
                    if (statusText) {
                        statusText.textContent = message || 'ë¼ì¦ˆë² ë¦¬íŒŒì´: ì—°ê²° ì•ˆ ë¨';
                    }
                    if (connectionStatus) {
                        connectionStatus.textContent = message || 'ì—°ê²° ì•ˆ ë¨';
                        connectionStatus.style.backgroundColor = 'var(--bg-medium)';
                        connectionStatus.style.color = 'var(--text-secondary)';
                    }
                    if (connectBtn) connectBtn.style.display = 'inline-block';
                    if (disconnectBtn) disconnectBtn.style.display = 'none';
                }
            }

            /**
             * ë¼ì¦ˆë² ë¦¬íŒŒì´ë¡œ ëª¨í„° ì œì–´ ëª…ë ¹ì„ ì „ì†¡í•©ë‹ˆë‹¤.
             */
            function sendMotorControl(pan, tilt) {
                if (!piConnected || !piWebSocket || piWebSocket.readyState !== WebSocket.OPEN) {
                    console.warn('ë¼ì¦ˆë² ë¦¬íŒŒì´ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return;
                }

                const command = {
                    type: 'motor_control',
                    pan: pan,
                    tilt: tilt,
                    timestamp: Date.now()
                };

                piWebSocket.send(JSON.stringify(command));
                console.log('ëª¨í„° ì œì–´ ëª…ë ¹ ì „ì†¡:', command);
            }

            /**
             * ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ê´€ë ¨ UI ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
             */
            function setupPiConnectionUI() {
                const connectBtn = document.getElementById('connect-pi-btn');
                const disconnectBtn = document.getElementById('disconnect-pi-btn');
                const piIpInput = document.getElementById('raspberry-pi-ip');
                const piPortInput = document.getElementById('raspberry-pi-port');

                if (connectBtn) {
                    connectBtn.addEventListener('click', () => {
                        const ip = piIpInput?.value.trim();
                        const port = parseInt(piPortInput?.value || '8765');

                        if (!ip) {
                            alert('ë¼ì¦ˆë² ë¦¬íŒŒì´ IP ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                            return;
                        }

                        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
                        if (!ipPattern.test(ip)) {
                            alert('ì˜¬ë°”ë¥¸ IP ì£¼ì†Œ í˜•ì‹ì„ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ: 192.168.1.100');
                            return;
                        }

                        connectToRaspberryPi(ip, port);
                    });
                }

                if (disconnectBtn) {
                    disconnectBtn.addEventListener('click', () => {
                        disconnectFromRaspberryPi();
                    });
                }

                if (piIpInput) {
                    piIpInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            connectBtn?.click();
                        }
                    });
                }
                if (piPortInput) {
                    piPortInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            connectBtn?.click();
                        }
                    });
                }

                updatePiConnectionStatus(false);
            }

            // ============================================
            // ì—…ë°ì´íŠ¸ ê´€ë¦¬ í•¨ìˆ˜
            // ============================================
            
            /**
             * ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
             */
            async function checkForUpdatesManually() {
                const updateModal = document.getElementById('update-modal');
                const updateChecking = document.getElementById('update-checking');
                const updateAvailable = document.getElementById('update-available');
                const updateLatest = document.getElementById('update-latest');
                const updateError = document.getElementById('update-error');

                if (!updateModal) return;
                updateModal.classList.add('visible');
                updateChecking.style.display = 'block';
                updateAvailable.style.display = 'none';
                updateLatest.style.display = 'none';
                updateError.style.display = 'none';

                try {
                    if (!isElectron || !window.electronAPI.invoke) {
                        updateChecking.style.display = 'none';
                        updateError.style.display = 'block';
                        return;
                    }

                    const updateInfo = await window.electronAPI.invoke('check-for-updates');
                    updateChecking.style.display = 'none';

                    if (!updateInfo) {
                        updateError.style.display = 'block';
                        return;
                    }

                    if (updateInfo.available) {
                        document.getElementById('update-current-version').textContent = updateInfo.currentVersion;
                        document.getElementById('update-latest-version').textContent = updateInfo.latestVersion;
                        document.getElementById('update-release-date').textContent = updateInfo.releaseDate || 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
                        document.getElementById('update-release-notes').textContent = updateInfo.releaseNotes || 'ì—…ë°ì´íŠ¸ê°€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.';
                        updateAvailable.style.display = 'block';
                    } else {
                        document.getElementById('update-current-version-latest').textContent = updateInfo.currentVersion;
                        updateLatest.style.display = 'block';
                    }
                } catch (error) {
                    console.error('ì—…ë°ì´íŠ¸ í™•ì¸ ì˜¤ë¥˜:', error);
                    updateChecking.style.display = 'none';
                    updateError.style.display = 'block';
                }
            }

            /**
             * ì—…ë°ì´íŠ¸ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
             */
            function downloadUpdate(downloadUrl) {
                if (isElectron && window.electronAPI.send) {
                    window.electronAPI.send('download-update', downloadUrl);
                } else {
                    window.open(downloadUrl, '_blank');
                }
            }

            /**
             * ì—…ë°ì´íŠ¸ ëª¨ë‹¬ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
             */
            function setupUpdateModal() {
                const updateModal = document.getElementById('update-modal');
                const updateDownloadBtn = document.getElementById('update-download-btn');
                const updateCloseBtn = document.getElementById('update-close-btn');
                const updateCloseLatestBtn = document.getElementById('update-close-latest-btn');
                const updateRetryBtn = document.getElementById('update-retry-btn');
                const updateCloseErrorBtn = document.getElementById('update-close-error-btn');

                if (updateDownloadBtn) {
                    updateDownloadBtn.addEventListener('click', async () => {
                        try {
                            const updateInfo = await window.electronAPI.invoke('check-for-updates');
                            if (updateInfo && updateInfo.available && updateInfo.downloadUrl) {
                                downloadUpdate(updateInfo.downloadUrl);
                                updateModal.classList.remove('visible');
                            } else {
                                alert('ë‹¤ìš´ë¡œë“œ URLì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        } catch (error) {
                            console.error('ë‹¤ìš´ë¡œë“œ URL ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                            alert('ì—…ë°ì´íŠ¸ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });
                }

                if (updateCloseBtn) updateCloseBtn.addEventListener('click', () => updateModal.classList.remove('visible'));
                if (updateCloseLatestBtn) updateCloseLatestBtn.addEventListener('click', () => updateModal.classList.remove('visible'));
                if (updateRetryBtn) updateRetryBtn.addEventListener('click', () => checkForUpdatesManually());
                if (updateCloseErrorBtn) updateCloseErrorBtn.addEventListener('click', () => updateModal.classList.remove('visible'));
            }

            /**
             * ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
             */
            async function checkForUpdatesAuto(silent = true) {
                try {
                    if (!isElectron || !window.electronAPI.invoke) return;

                    const updateInfo = await window.electronAPI.invoke('check-for-updates');

                    if (updateInfo && updateInfo.available) {
                        const shouldUpdate = confirm(
                            `ìƒˆë¡œìš´ ì—…ë°ì´íŠ¸ê°€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!\n\n` +
                            `í˜„ì¬ ë²„ì „: ${updateInfo.currentVersion}\n` +
                            `ìµœì‹  ë²„ì „: ${updateInfo.latestVersion}\n\n` +
                            `ì§€ê¸ˆ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                        );

                        if (shouldUpdate) {
                            checkForUpdatesManually();
                        }
                    }
                } catch (error) {
                    console.error('ìë™ ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨:', error);
                }
            }

            // ============================================
            // ì´ˆê¸°í™” ì‹¤í–‰
            // ============================================
            
            /**
             * ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
             * í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰ë©ë‹ˆë‹¤.
             */
            (async function init() {
                try {
                    // ì˜¤ë””ì˜¤ ë¯¹ì„œ ì»¨íŠ¸ë¡¤ ì„¤ì •
                    setupAudioMixerControls();
                    
                    // ì¥ë©´ íŒ¨ë„ ì„¤ì •
                    setupScenesPanel();
                    
                    // ì†ŒìŠ¤ íŒ¨ë„ ì„¤ì •
                    setupSourcesPanel();
                    
                    // ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° UI ì„¤ì •
                    setupPiConnectionUI();
                    
                    // ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ì„¤ì •
                    setupUpdateModal();
                    
                    // ì¹´ë©”ë¼/ë§ˆì´í¬ ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    await getDevices();
                    
                    // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                    const savedSettings = loadSettings();
                    
                    // ì €ì¥ëœ ì„¤ì •ì´ ìˆìœ¼ë©´ ì ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ì¥ì¹˜ë¡œ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
                    if (savedSettings && savedSettings.videoSource && savedSettings.audioSource) {
                        await startStream(savedSettings.videoSource, savedSettings.audioSource);
                        console.log('ì €ì¥ëœ ì„¤ì •ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¼ ì‹œì‘');
                    } else {
                        await startStream();
                        console.log('ê¸°ë³¸ ì¥ì¹˜ë¡œ ìŠ¤íŠ¸ë¦¼ ì‹œì‘');
                    }
                    
                    console.log('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');
                } catch (error) {
                    console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                }
            })();
        });
    </script>

</body>
</html>